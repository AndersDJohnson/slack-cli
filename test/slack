#!/usr/bin/env bats

setup() {
  sleep 2
}

@test 'init should succeed' {
  if [ -z "${SLACK_CLI_TOKEN}" ]; then
    skip 'project environment variables should be defined'
  fi

  echo -e "${SLACK_CLI_TOKEN}" | build/bin/slack init
}

@test 'chat send using public channel via argument should succeed' {
  if ! [ -f 'build/etc/slack' ]; then skip 'project should be initialized'; fi

  build/bin/slack chat send 'chat send using public channel via argument should succeed' '#slack-cli'
}

@test 'chat send using private channel via argument should succeed' {
  if ! [ -f 'build/etc/slack' ]; then skip 'project should be initialized'; fi

  build/bin/slack chat send 'chat send using private channel via argument should succeed' slack-cli-private
}

@test 'chat send using direct channel via argument should succeed' {
  if ! [ -f 'build/etc/slack' ]; then skip 'project should be initialized'; fi

  build/bin/slack chat send 'chat send using direct channel via argument should succeed' @rockymadden
}

@test 'chat send using non-existent channel should fail' {
  if ! [ -f 'build/etc/slack' ]; then skip 'project should be initialized'; fi

  run build/bin/slack chat send 'chat send using non-existent channel should fail' --channel='#nonexistent'
  [ $status -eq 1 ]
}

@test 'chat send using rich formatting should succeed' {
  if ! [ -f 'build/etc/slack' ]; then skip 'project should be initialized'; fi

  build/bin/slack chat send 'text' --pretext='chat send using rich formatting should succeed'
}

@test 'send via pipe should succeed' {
  if ! [ -f 'build/etc/slack' ]; then skip 'project should be initialized'; fi

  ls -al | build/bin/slack chat send --pretext='send via pipe should succeed'
}

@test '-h should output usage' {
  run build/bin/slack -h
  [ $status -eq 0 ]
  [ "${#lines[@]}" -gt 1 ]
}

@test '--help should output usage' {
  run build/bin/slack --help
  [ $status -eq 0 ]
  [ "${#lines[@]}" -gt 1 ]
}

@test '-v should output version' {
  run build/bin/slack -v
  [ $status -eq 0 ]
  [ $(expr "$output" : 'v*') -ne 0 ]
}

@test '--version should output version' {
  run build/bin/slack --version
  [ $status -eq 0 ]
  [ $(expr "$output" : 'v*') -ne 0 ]
}
